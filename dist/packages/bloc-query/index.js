"use strict";var T=Object.defineProperty;var C=(i,e,t)=>e in i?T(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var s=(i,e,t)=>(C(i,typeof e!="symbol"?e+"":e,t),t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const u=require("@jacobtipp/bloc"),o=require("rxjs");class y{constructor(){s(this,"_");s(this,"name","QueryEvent")}}class d extends y{constructor(t,r=!1){super();s(this,"name","QueryFetchEvent");this.abortController=t,this.cancel=r}}class w extends y{constructor(){super(...arguments);s(this,"name","QueryCancelEvent")}}class D extends y{constructor(){super(...arguments);s(this,"name","SetQueryDataEvent")}}class q extends y{constructor(){super(...arguments);s(this,"name","QueryRevalidateEvent")}}class x extends y{constructor(t){super();s(this,"name","QueryErrorEvent");this.error=t}}const S=i=>new o.Observable(e=>(e.next(i),()=>{i.abortController.abort()})),b=(i,e)=>(t,r)=>t.pipe(o.switchMap(S)).pipe(o.switchMap(a=>r(a).pipe(o.retry({delay:(n,c)=>{const v=c,Q={maxRetryAttempts:1,retryDuration:1e3,scalingDuration:1e3},l=i.retryWhen?i.retryWhen(n,v):{},M=(l==null?void 0:l.maxRetryAttempts)??i.maxRetryAttempts??Q.maxRetryAttempts,R=(l==null?void 0:l.scalingDuration)??i.scalingDuration??Q.scalingDuration,A=(l==null?void 0:l.retryDuration)??i.retryDuration??Q.retryDuration;if(v>M&&!e.isClosed){const m=new x(n);u.Bloc.observer.onEvent(e,m);const p={status:"isError",lastUpdatedAt:e.state.lastUpdatedAt,isInitial:!1,isLoading:!1,isFetching:!1,isReady:!1,isError:!0,data:e.state.data,error:n};return e.__unsafeEmit__(p),u.Bloc.observer.onTransition(e,new u.Transition(e.state,m,p)),o.EMPTY}const F=(l==null?void 0:l.retryDuration)??i.retryDuration;return o.timer(F?A:v*R)}}))));class g extends u.Bloc{constructor(t,r){const a=`QueryBloc - ${r.name??r.queryKey}`;super(t,{name:a});s(this,"staleTime");s(this,"logErrors");s(this,"handledInitialLoad",!1);s(this,"revertedState");s(this,"getQuery",(t,r)=>{if(this.isClosed)throw new f("Query is closed");return this.state.status==="isLoading"&&!this.handledInitialLoad&&(this.handledInitialLoad=!0,this.revertedState=this.state,this.add(new d(new AbortController))),this.state.isReady&&this.isStale&&this.revalidateQuery(),this.state$.pipe(o.startWith(this.state),o.filter(({isReady:a,isError:n})=>t?a||n:!0),o.map(a=>{if(a.isError&&t)throw a.error;return t?t(a):a}),o.distinctUntilChanged(r))});s(this,"setQueryData",t=>{let r;if(typeof t=="function"){if(this.state.data===void 0)throw new h("SetQueryData: cannot be set with a callback function if previous data is undefined, invoke setQueryData with data directly or provide initial data for the query");r=t(this.state.data)}else r=t;const a=new D;u.Bloc.observer.onEvent(this,a);const n=this.state,c={status:"isReady",isInitial:!1,lastUpdatedAt:Date.now(),isLoading:!1,isFetching:!1,isReady:!0,isError:!1,data:r};this.emit(c),u.Bloc.observer.onTransition(this,new u.Transition(n,a,c))});s(this,"cancelQuery",()=>{if(!this.state.isFetching)return;this.state.isLoading&&this.handledInitialLoad&&(this.handledInitialLoad=!1),this.add(new d(new AbortController,!0));const t=new w;u.Bloc.observer.onEvent(this,t);const r=this.state;this.emit(this.revertedState),u.Bloc.observer.onTransition(this,new u.Transition(r,t,this.state))});s(this,"revalidateQuery",()=>{this.cancelQuery(),this.revertedState=this.state;const t=new q;u.Bloc.observer.onEvent(this,t);const r={status:"isFetching",lastUpdatedAt:this.state.lastUpdatedAt,isInitial:!1,isLoading:!1,isFetching:!0,isReady:!1,isError:!1,data:this.state.data};this.emit(r),u.Bloc.observer.onTransition(this,new u.Transition(this.revertedState,t,r)),this.add(new d(new AbortController))});this.options=r,this.revertedState=t,this.staleTime=r.staleTime??0,this.logErrors=r.logErrors??!1,this.on(d,this.onQueryFetch,b({maxRetryAttempts:r.maxRetryAttempts,retryDuration:r.retryDuration,scalingDuration:r.scalingDuration,retryWhen:r.retryWhen},this))}onError(t){this.logErrors&&super.onError(t)}async onQueryFetch(t,r){if(t.cancel)return;const a=t.abortController.signal;try{const n=await this.options.queryFn({signal:a});r({status:"isReady",lastUpdatedAt:Date.now(),isInitial:!1,isLoading:!1,isFetching:!1,isReady:!0,isError:!1,data:n})}catch(n){if(!a.aborted)throw n}}get isStale(){const t=Date.now();return this.state.lastUpdatedAt+this.staleTime<=t}}class h extends Error{constructor(e){super(e),Object.setPrototypeOf(this,h.prototype)}}class f extends Error{constructor(e){super(e),Object.setPrototypeOf(this,f.prototype)}}class L{constructor(){s(this,"queryMap",new Map);s(this,"getQuery",e=>this.queryMap.has(e.queryKey)?this.queryMap.get(e.queryKey).getQuery(e.selector,e.comparator):this.createQuery(e).getQuery(e.selector,e.comparator));s(this,"getQueryData",async e=>{var r;const t=typeof e=="string"?(r=this.queryMap.get(e))==null?void 0:r.getQuery():e;if(t)return o.firstValueFrom(t.pipe(o.filter(a=>a.isReady||a.isError),o.map(a=>{if(a.isError)throw a.error;return a.data})));throw new E(`QueryNotFoundException: query ${e} does not exist in the QueryClient.`)});s(this,"clear",()=>{this.queryMap.forEach(e=>{e.close()}),this.queryMap.clear()});s(this,"removeQuery",e=>{if(this.queryMap.has(e)){const t=this.queryMap.get(e);return t==null||t.close(),this.queryMap.delete(e)}return!1});s(this,"getQueryKeys",()=>Array.from(this.queryMap.keys()));s(this,"setQueryData",(e,t)=>{const r=this.queryMap.get(e);r&&r.setQueryData(t)});s(this,"revalidateQueries",e=>{const t=e==null?void 0:e.predicate,r=e==null?void 0:e.queryKey;this.getQueryKeys().forEach(a=>{var n,c;if(!t&&!r)return(n=this.queryMap.get(a))==null?void 0:n.revalidateQuery();(r&&r===a||t&&t(a))&&((c=this.queryMap.get(a))==null||c.revalidateQuery())})});s(this,"cancelQuery",e=>{var t;(t=this.queryMap.get(e))==null||t.cancelQuery()})}createQuery(e){if(e.initialData!==void 0){const t=new g({status:"isInitial",lastUpdatedAt:Date.now(),isInitial:!0,isFetching:!1,isLoading:!1,isReady:!0,isError:!1,data:e.initialData},e);return this.queryMap.set(e.queryKey,t),t}else{const t=new g({status:"isLoading",lastUpdatedAt:Date.now(),isInitial:!1,isFetching:!0,isLoading:!0,isReady:!1,isError:!1},e);return this.queryMap.set(e.queryKey,t),t}}}class E extends Error{constructor(e){super(e),Object.setPrototypeOf(this,E.prototype)}}exports.QueryBloc=g;exports.QueryCancelEvent=w;exports.QueryClient=L;exports.QueryClosedException=f;exports.QueryErrorEvent=x;exports.QueryEvent=y;exports.QueryFetchEvent=d;exports.QueryNotFoundException=E;exports.QueryRevalidateEvent=q;exports.SetQueryDataEvent=D;exports.SetQueryDataException=h;exports.queryFetchTransformer=b;
